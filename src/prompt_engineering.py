# 系統提示詞
SYSTEM_PROMPT = """
您是一位才華橫溢的華語文學創作者，擅長創作引人入勝的故事。您的創作：
1. 文筆細膩優美，善於營造氛圍
2. 人物形象鮮活，性格特徵鮮明
3. 情節安排巧妙，故事結構完整
4. 主題深刻動人，寓意豐富深遠
5. 善用中文寫作特色，如意象、典故等

請根據提供的要求進行創作，確保：
- 故事情節合理流暢
- 人物塑造立體真實
- 場景描寫細膩生動
- 情感表達真摯動人
- 文字優美而不失凝練
"""

# 提示詞模板
STORY_PROMPT_TEMPLATE = """
您是一位專業的{genre}作家，擅長以{tone}的筆觸創作。請根據以下要求創作一個引人入勝的故事：

核心要求：
1. 主題：{theme}
2. 體裁：{genre}
3. 基調：{tone}
4. 關鍵元素：{elements}

創作指南：
1. 故事結構：
   - 設置引人入勝的開場或衝突
   - 通過有意義的事件推動情節
   - 精心設計故事轉折點
   - 提供令人滿意的結尾

2. 人物塑造：
   - 創造鮮活、令人難忘的角色
   - 建立清晰的動機和性格特徵
   - 通過對話和行動展現人物成長

3. 場景營造：
   - 描繪豐富細膩的環境
   - 營造符合主題的氛圍
   - 注重空間與情感的呼應

4. 寫作技巧：
   - 運用生動的描述性語言
   - 把握故事節奏
   - 確保敘事連貫
   - 善用中文寫作特色（意象、典故等）

5. 情感共鳴：
   - 深化情感連結
   - 創造有意義的人物關係
   - 融入細膩的情感表達

技術要求：
- 字數控制在1000字左右（±10%）
- 自然地融入所有關鍵元素
- 全程保持讀者興趣
- 符合{genre}的文體特點
- 注重文學性與可讀性的平衡
"""

# 根據反饋重新生成的提示詞模板
REGENERATE_PROMPT_TEMPLATE = """
作為一位經驗豐富的{genre}作家，請仔細分析讀者的反饋，並據此改進故事：

讀者反饋：
{feedback}

反饋分析與改進方向：
1. 請先仔細分析讀者反饋中提到的：
   - 需要改進的具體方面
   - 故事中的優秀之處
   - 讀者的核心期待

2. 根據反饋確定修改重點：
   - 優先處理讀者提出的問題
   - 強化讀者認可的優點
   - 補充讀者期待的元素

原始故事：
{original_story}

故事基本要求：
- 主題：{theme}
- 體裁：{genre}
- 基調：{tone}
- 關鍵元素：{elements}

創作指引：
1. 以讀者反饋為核心進行改寫：
   - 重點改進讀者提出的問題
   - 保留並加強讀者喜歡的部分
   - 補充讀者建議的新元素

2. 在改進過程中注意：
   - 故事結構的完整性
   - 人物塑造的連貫性
   - 情節發展的合理性
   - 文字表達的優美性

3. 品質把控：
   - 字數維持在1000字左右（±10%）
   - 確保{tone}的基調
   - 符合{genre}的特點
   - 保持文學性與可讀性

請以讀者的反饋為主要指導，創作一個更好的版本。重點關注讀者提出的具體建議，同時確保故事的整體品質。
"""


def generate_story_prompt(preferences: dict) -> str:
    """生成初始提示詞"""
    return STORY_PROMPT_TEMPLATE.format(
        theme=preferences['theme'],
        genre=preferences['genre'],
        tone=preferences['tone'],
        elements=', '.join(preferences['key_elements'])
    )

def generate_regenerate_prompt(preferences: dict, previous_content: str, feedback: str) -> str:
    """根據反饋生成重新生成的提示詞"""
    
    # 根據評分決定改變程度的提示
    rating_guide = {
        1: "請大幅改寫故事，保留不超過20%的原有內容。",
        2: "請進行較大改寫，保留約30%的原有內容。",
        3: "請適度改寫，保留約50%的原有內容。",
        4: "請小幅改寫，保留約70%的原有內容。",
        5: "請微調故事，保留約85%的原有內容。"
    }
    
    base_prompt = f"""
您是一位優秀的故事創作者。請根據以下資訊重新創作故事：

主題：{preferences['theme']}
類型：{preferences['genre']}
語氣：{preferences['tone']}
關鍵元素：{', '.join(preferences['key_elements'])}

上一版本的內容：
{previous_content}

用戶反饋：
{feedback}

{rating_guide[preferences['rating']]}

創作要求：
1. 根據用戶反饋調整故事內容
2. 保持故事的連貫性和完整性
3. 確保符合主題和風格要求
4. 加強情感表達和細節描寫
5. 優化故事結構和節奏
"""
    return base_prompt

def chain_of_thought(task: dict) -> list[str]:
    """
    將故事生成任務分解為多個子提示詞，作為主提示詞的輔助思考工具
    
    Args:
        task: 包含故事生成所需信息的字典，格式與generate_story_prompt的preferences相同
        
    Returns:
        list[str]: 按順序排列的輔助思考提示詞列表
    """
    # 1. 故事骨架設計
    structure_prompt = f"""
    為這個{task['genre']}設計整體框架：

    請以自由思考的方式，探索以下幾個方面：
    - 「{task['theme']}」這個主題可以展現什麼樣的故事主線？
    - 圍繞這個主題，可以設置什麼樣的核心衝突？
    - 如何通過故事結構來強化主題表達？
    - 情節發展的關鍵轉折點應該是什麼？

    請提供你的思考和建議，不必拘泥於固定格式。
    """
    
    # 2. 人物塑造規劃
    character_prompt = f"""
    設計能夠承載{task['theme']}主題的人物：

    請以開放的視角思考：
    - 需要什麼樣的人物來演繹這個故事？
    - 人物之間應該具有什麼樣的關係？
    - 如何通過人物成長來體現主題？
    - 人物的內心世界應該如何展現？

    請自由發揮你的想法，說明這些人物如何豐富故事。
    """
    
    # 3. 情節鋪陳策略
    plot_prompt = f"""
    規劃如何展開故事情節，整合這些元素：{', '.join(task['key_elements'])}

    請從創作角度思考：
    - 情節應該如何層層推進？
    - 各個關鍵元素在什麼時候、以什麼方式出現最恰當？
    - 如何讓情節發展順暢自然？
    - 結局應該如何收束？

    請分享你對情節安排的想法和建議。
    """
    
    # 4. 氛圍營造方案
    atmosphere_prompt = f"""
    探討如何營造{task['tone']}的故事氛圍：

    請從感性角度思考：
    - 如何通過場景描寫營造氛圍？
    - 情感基調應該如何起伏變化？
    - 用什麼樣的筆觸能夠感染讀者？
    - 如何讓{task['tone']}的基調更加豐富立體？

    請描述你對故事氛圍營造的設想。
    """
    
    # 5. 文化意蘊深化
    cultural_prompt = f"""
    思考如何豐富故事的文化內涵：

    請從更深層次思考：
    - 故事中可以融入哪些文化元素？
    - 如何讓文化內涵自然地融入情節？
    - 有什麼文化意象可以使用？
    - 如何處理傳統與現代的平衡？

    請分享你對於文化內涵表達的想法。
    """
    
    return [
        structure_prompt,
        character_prompt,
        plot_prompt,
        atmosphere_prompt,
        cultural_prompt
    ]